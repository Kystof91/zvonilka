# Правила разработки приложения голосовых звонков на Next.js

## 1. ОБЩЕЕ ОПИСАНИЕ ПРОЕКТА

### Назначение приложения
Создание минималистичного веб-приложения для голосовых звонков через интернет с высоким качеством звука и минимальной задержкой. Приложение должно работать в браузере без установки дополнительного программного обеспечения.

### Ключевые цели
- Высококачественная голосовая связь (HD audio)
- Задержка менее 200ms
- Стабильное соединение с автоматическим переподключением
- Минималистичный и интуитивный интерфейс
- Готовность к деплою на Vercel

## 2. ТЕХНОЛОГИЧЕСКИЙ СТЕК

### Обязательные технологии
```json
{
  "next": "^14.0.0",
  "react": "^18.2.0",
  "typescript": "^5.0.0",
  "socket.io-client": "^4.6.0",
  "socket.io": "^4.6.0",
  "tailwindcss": "^3.3.0",
  "@tailwindcss/forms": "^0.5.0",
  "lucide-react": "^0.294.0"
}
```

### Опциональные (рекомендуемые)
```json
{
  "simple-peer": "^9.11.1",
  "@vercel/analytics": "^1.0.0"
}
```

### Структура проекта
```
/
├── app/
│   ├── layout.tsx              # Root layout
│   ├── page.tsx                 # Главная страница (UI приложения)
│   ├── api/
│   │   └── socket/
│   │       └── route.ts         # Socket.io API route
│   └── globals.css              # Глобальные стили
├── components/
│   ├── UserInput.tsx            # Форма ввода имени
│   ├── CallInterface.tsx        # Интерфейс звонка
│   ├── CallControls.tsx         # Кнопки управления
│   └── AudioVisualizer.tsx      # Визуализация аудио
├── lib/
│   ├── webrtc.ts               # WebRTC логика
│   ├── socket.ts               # Socket.io клиент
│   └── utils.ts                # Утилиты
├── public/                     # Статические файлы
├── package.json
├── tsconfig.json
├── tailwind.config.js
├── next.config.js
└── .env.local                  # Environment variables
```

## 3. ФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 3.1 Система пользователей
- **Вход**: Пользователь вводит только свое имя (ID пользователя генерируется автоматически)
- **Идентификация**: Каждому пользователю присваивается уникальный ID
- **Сохранение**: ID хранится в localStorage для повторных сессий

### 3.2 Инициирование звонка
- Пользователь вводит ID/имя собеседника в поле поиска
- Нажатие кнопки "Позвонить" отправляет запрос на звонок
- Статус "Звонок..." отображается до ответа

### 3.3 Прием звонка
- Входящий звонок отображается модальным окном с именем звонящего
- Кнопки "Принять" и "Отклонить"
- Автоматическое уведомление (звуковой/вибро)

### 3.4 Управление звонком
- **Кнопка "Завершить"**: Разрывает соединение
- **Кнопка "Отключить микрофон"**: Mute/unmute
- **Индикатор статуса**: Показывает статус звонка визуально

### 3.5 Качество связи
- **Автоматическое переподключение** при обрыве связи
- **Эхо-подавление**: Автоматическое
- **Подавление шума**: Встроенное в браузере
- **Автоматическая регулировка громкости**: Auto gain control

## 4. АРХИТЕКТУРНЫЕ ПРАВИЛА

### 4.1 Next.js App Router
- Использовать Server Components по умолчанию
- Client Components только там, где нужна интерактивность
- API Routes в папке `app/api/`

### 4.2 WebRTC конфигурация
```typescript
const rtcConfig: RTCConfiguration = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    // При необходимости добавить TURN серверы
  ],
  iceCandidatePoolSize: 10,
  bundlePolicy: 'max-bundle',
  rtcpMuxPolicy: 'require'
}
```

### 4.3 Audio constraints
```typescript
const audioConstraints: MediaStreamConstraints = {
  audio: {
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true,
    sampleRate: 48000,
    channelCount: 1,
    latency: 0.01,
    volume: 1.0
  }
}
```

### 4.4 Socket.io сигнализация
- События для управления: `call-request`, `call-accepted`, `call-rejected`, `call-ended`
- Обмен ICE candidates: `ice-candidate`
- Обмен SDP offers/answers: `offer`, `answer`

### 4.5 Структура state management
- Использовать React hooks (useState, useEffect)
- Context API для глобального состояния звонка
- Хранение ID пользователя в localStorage

## 5. ТРЕБОВАНИЯ К КАЧЕСТВУ СВЯЗИ

### 5.1 Audio settings
- **Codec**: Opus (предпочтительно) или G.722
- **Sample Rate**: 48 kHz
- **Bitrate**: Минимум 32 kbps, оптимально 64-96 kbps
- **Latency**: Цель < 200ms, максимум 500ms
- **Packet Loss**: Терпимость до 5%

### 5.2 Настройки MediaStream
- **echoCancellation**: true (критично)
- **noiseSuppression**: true (желательно)
- **autoGainControl**: true (желательно)
- **sampleRate**: 48000
- **channelCount**: 1 (моно для экономии)

### 5.3 Мониторинг качества
- Логирование WebRTC stats каждые 5 секунд
- Отображение индикатора качества связи пользователю
- Автоматическое переключение codec при проблемах

## 6. UI/UX ТРЕБОВАНИЯ

### 6.1 Дизайн-система
- **Цвета**: Минималистичная палитра (темный/светлый режим)
- **Типографика**: Четкий, читаемый шрифт (Inter или System font)
- **Иконки**: Lucide React для единообразия
- **Анимации**: Плавные переходы 150-300ms

### 6.2 Компоненты интерфейса
- **Форма входа**: Центрированная, минималистичная
- **Поле поиска**: С автокомплитом (если есть список пользователей)
- **Кнопки**: Ясные CTA с hover-эффектами
- **Индикаторы**: Визуализация статуса звонка
- **Модальные окна**: Для входящих звонков

### 6.3 Адаптивность
- Mobile-first подход
- Минимальная ширина: 320px
- Переключение между компактным/полным видом
- Сенсорное управление (touch-friendly)

### 6.4 Обратная связь
- Плавные анимации при действиях
- Звуковые уведомления (опционально, можно отключить)
- Toast-уведомления для важных событий
- Лоадеры при загрузке/соединении

## 7. БЕЗОПАСНОСТЬ И ПРОИЗВОДИТЕЛЬНОСТЬ

### 7.1 Безопасность
- Валидация входных данных (имена, ID)
- Rate limiting для предотвращения спама
- Sanitization пользовательского ввода
- HTTPS обязателен (Vercel обеспечивает)

### 7.2 Оптимизация
- Code splitting для уменьшения bundle size
- Lazy loading компонентов
- Оптимизация WebRTC (bundle, rtcp-mux)
- Кэширование статических ресурсов

### 7.3 Мониторинг
- Логирование ошибок
- Analytics (Vercel Analytics)
- Performance monitoring

## 8. DEPLOYMENT НА VERCEL

### 8.1 Требования
- Next.js проект настроен для App Router
- TypeScript компилируется без ошибок
- Environment variables настроены

### 8.2 Файл vercel.json
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  }
}
```

### 8.3 Environment variables
```
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://your-app.vercel.app
```

### 8.4 Инструкции деплоя
1. Создать репозиторий на GitHub
2. Подключить проект к Vercel
3. Установить environment variables
4. Деплой автоматический при push в main

## 9. ДЕТАЛЬНАЯ ТЕХНИЧЕСКАЯ РЕАЛИЗАЦИЯ

### 9.1 WebRTC peer connection flow
```
1. Пользователь A вводит ID пользователя B
2. A отправляет call-request через Socket.io
3. B получает уведомление и может принять/отклонить
4. При принятии: обмен SDP offers/answers
5. Установление P2P соединения через STUN/TURN
6. Exchange ICE candidates
7. Начало передачи аудио
```

### 9.2 Socket.io events
```typescript
// Client → Server
'join-room': { userId: string }
'call-request': { from: string, to: string }
'call-accept': { from: string, to: string }
'call-reject': { from: string, to: string }
'call-end': { userId: string }
'offer': { from: string, to: string, offer: RTCSessionDescriptionInit }
'answer': { from: string, to: string, answer: RTCSessionDescriptionInit }
'ice-candidate': { from: string, to: string, candidate: RTCIceCandidateInit }

// Server → Client
'incoming-call': { from: string, fromName: string }
'call-accepted': { userId: string }
'call-rejected': { userId: string }
'call-ended': { userId: string }
'offer': { from: string, offer: RTCSessionDescriptionInit }
'answer': { from: string, answer: RTCSessionDescriptionInit }
'ice-candidate': { from: string, candidate: RTCIceCandidateInit }
```

### 9.3 Error handling
- Обработка ошибок WebRTC
- Retry logic для переподключения
- Fallback на альтернативные STUN серверы
- Graceful degradation при проблемах с сетью

## 10. ОГРАНИЧЕНИЯ И ОСОБЕННОСТИ

### 10.1 Известные ограничения
- Браузерные ограничения: некоторые браузеры требуют HTTPS для WebRTC
- NAT/Firewall: может потребоваться TURN сервер для сложных сетей
- Количество одновременных соединений: максимум несколько звонков

### 10.2 Совместимость браузеров
- Chrome 74+
- Firefox 68+
- Safari 12.1+
- Edge 79+

### 10.3 Особенности реализации
- TURN серверы не обязательны для простых случаев
- Можно использовать бесплатные STUN серверы Google
- Для production рекомендуется настройка собственного TURN сервера

## 11. ТЕСТИРОВАНИЕ

### 11.1 Локальное тестирование
- Тестирование на localhost (HTTP допустим для WebRTC в dev mode)
- Тестирование двух вкладок/устройств
- Проверка качества звука

### 11.2 Production тестирование
- Тестирование разных сетей (WiFi, мобильный интернет)
- Тестирование на разных устройствах
- Стресс-тестирование продолжительных звонков

## 12. ROADMAP РАЗРАБОТКИ

### Фаза 1: MVP (базовая функциональность)
- [ ] Настройка Next.js проекта
- [ ] Базовая UI с формой входа
- [ ] Socket.io сервер
- [ ] WebRTC peer connection
- [ ] Основные кнопки управления

### Фаза 2: Качество и стабильность
- [ ] Оптимизация audio settings
- [ ] Добавление TURN серверов
- [ ] Система переподключений
- [ ] Мониторинг качества связи

### Фаза 3: UX улучшения
- [ ] Анимации и визуальная обратная связь
- [ ] Индикаторы статуса
- [ ] Звуковые уведомления
- [ ] Темная/светлая тема

### Фаза 4: Production готовность
- [ ] Оптимизация bundle
- [ ] SEO и мета-теги
- [ ] Analytics
- [ ] Деплой на Vercel

## 13. ПРИОРИТЕТЫ ПРИ РАЗРАБОТКЕ

### Критичные (должны быть реализованы в первую очередь)
1. ✅ Стабильное WebRTC соединение
2. ✅ Высокое качество звука
3. ✅ Минимальная задержка
4. ✅ Базовая функциональность звонка

### Важные (для хорошего UX)
1. Автоматическое переподключение
2. Чистый UI
3. Индикаторы статуса
4. Обработка ошибок

### Желательные (могут быть добавлены позже)
1. История звонков
2. Контакты
3. Статистика качества
4. Расширенные настройки аудио

## 14. КРИТЕРИИ УСПЕХА

### Минимальные критерии MVP
- Звонок устанавливается успешно
- Звук четкий и понятный
- Задержка менее 500ms
- Статус звонка отображается корректно
- Можно завершить звонок

### Целевые критерии
- Задержка менее 200ms
- Качество HD
- Нет сбоев при нормальном использовании
- Интерфейс интуитивно понятен
- Работает на всех современных браузерах

## 15. ЧЕКЛИСТ ПЕРЕД ДЕПЛОЕМ

- [ ] Проект собирается без ошибок
- [ ] Все типы TypeScript корректны
- [ ] UI тестировался на разных устройствах
- [ ] Звонки работают стабильно
- [ ] Нет консольных ошибок
- [ ] Environment variables настроены
- [ ] `.env.local` не содержит секретов
- [ ] README.md обновлен
- [ ] package.json корректный

---

**Версия документа**: 1.0  
**Дата создания**: 2024  
**Последнее обновление**: 2024

